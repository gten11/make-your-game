<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Game</title>
    <link rel ="stylesheet" href ="index.css">
</head>

<body>
    <div id="gameName">Space Invaders</div>
    <div id="instructionStart">Press "space bar" to start</div>
    <div id ="game">
        <img id ="asteroid1" src="images/asteroid1.png">
        <img id ="asteroid2" src="images/asteroid2.png">
        <img id ="asteroid3" src="images/asteroid3.png">
        <img id ="asteroid4" src="images/asteroid4.png">
        <img id="myShip" src="images/myShip.png">
        <img id="myShooter" src="images/myShooter.png">
        <img id ="bullet" src="images/bullet.png">

    </div>
</body>

<script>

    function startGame() {
        const gameName = document.getElementById("gameName")
        const instr = document.getElementById("instructionStart")
        gameName.style.animation = "fadeOut 3s forwards"
        instr.style.animation = "fadeOut 3s forwards"
    }

    document.addEventListener("keydown", (event) => {
        if (event.key === " ") {
            startGame()
        }
    })
</script>

<script>
    let stopGame = true
    const game = document.getElementById("game")
    const myShooter = document.getElementById("myShooter")
    const asteroid1 = document.getElementById("asteroid1")
    const asteroid2 = document.getElementById("asteroid2")
    const asteroid3= document.getElementById("asteroid3")
    const asteroid4 = document.getElementById("asteroid4")
    const gameWhere = game.getBoundingClientRect()
    const gameLeft = gameWhere.left
    const gameHeight = gameWhere.height
    const asteroidWhere1 = asteroid1.getBoundingClientRect()
    const asteroidWhere2 = asteroid2.getBoundingClientRect()
    const asteroidWhere3 = asteroid3.getBoundingClientRect()
    const asteroidWhere4 = asteroid4.getBoundingClientRect()
    const asteroid1Left = asteroidWhere1.left - gameLeft
    const asteroid1Right = asteroidWhere1.right - gameLeft
    const asteroid2Left = asteroidWhere2.left - gameLeft
    const asteroid2Right = asteroidWhere2.right - gameLeft
    const asteroid3Left = asteroidWhere3.left - gameLeft
    const asteroid3Right = asteroidWhere3.right - gameLeft
    const asteroid4Left = asteroidWhere4.left - gameLeft
    const asteroid4Right = asteroidWhere4.right - gameLeft
   
    let bullets = []
    let left = 0;
    let countBullet = 0;
    let direction = 1;
    
    function moveShooter() {
        const gameWidth = document.getElementById("game").offsetWidth;
        const shooterWidth = document.getElementById("myShooter").offsetWidth;
        left += direction * 2;
        if (left + shooterWidth >= gameWidth || left <= 0) {
            direction *= (-1);
        }
        myShooter.style.left = left + 'px'
    }

    function myBullets() {
        countBullet++
        let name = "myBullet" + countBullet;
        const myBullet = document.createElement("img")
        myBullet.id = name
        myBullet.src = "images/bulletMine.png"
        myBullet.style.width = "1vw";
        myBullet.style.position = "absolute"
        myBullet.style.left = left + 22 + 'px';
        myBullet.style.bottom = "25vh";
        game.appendChild(myBullet);
        bullets.push(myBullet)
    }

    function moveBullets() {
        for (bullet of bullets) {
            let bottomStr = bullet.style.bottom
            if (bottomStr.endsWith("vh")) {
            bottomStr = bullet.style.bottom.slice(0,-2)
            } else {
                continue
            }
            let bottom = parseFloat(bottomStr, 10)
            bottom += 2
            if (bottom >= 88) {//here need to convert to vh or px to be determined
                bullet.remove()
            } else {
            bullet.style.bottom = bottom + 'vh';
            }
        }
    }

    function gameLoop() {
        if (stopGame) {
            return
        }
        moveShooter()
        if (left % 15 === 0 && !((left > asteroid1Left && left < asteroid1Right) || (left > asteroid2Left && left < asteroid2Right) || (left > asteroid3Left && left < asteroid3Right) || (left > asteroid4Left && left < asteroid4Right)) ) {
        myBullets()
        }
        moveBullets()
        requestAnimationFrame(gameLoop)
    }

    document.addEventListener("keydown", (event) => {
        if (event.key === " ") {
            stopGame = !stopGame;
            if (!stopGame) {
            gameLoop()
        }
        }
    })
    
    gameLoop()
  
</script>

<script>
    myShip = document.getElementById("myShip")
    let movingRight = false;
    let movingLeft = false;

    document.addEventListener("keydown", (event) => {
        if (event.key === "ArrowLeft") {
            movingLeft = true;
        } else if (event.key === "ArrowRight") {
            movingRight = true;
        }
    })

    document.addEventListener("keyup", (event) => {
        if (event.key === "ArrowLeft") {
            movingLeft = false;
        } else if (event.key === "ArrowRight") {
            movingRight = false;
        }
    })

    const myShipWidth = myShip.offsetWidth;
    const gameWidth = document.getElementById("game").offsetWidth;

    let startPosition = 0 + gameWidth / 2;
    let leftMostPosition = 0 + myShipWidth/2;

    function moveShip() {
        let left = parseInt(myShip.style.left || startPosition,10)
        if (movingLeft) {
            left -= 4;
        } else if (movingRight) {
            left += 4;
       
        }
        left = Math.max(leftMostPosition, Math.min(left, gameWidth - myShipWidth / 2))
        myShip.style.left = left + 'px';
        requestAnimationFrame(moveShip);
    }

    moveShip()
   
</script>

<script>
    const myShip = document.getElementById("myShip")
    let shipPrevPostion = myShip.getBoundingClientRect().left
    const shipBulletWidth = 0.99933
    let shipBullets = []
    let animating = false

    function vwToPx(vw) {
        return (vw / 100) * window.innerWidth;
    }

    function pxToVw(px) {
        return (px / window.innerWidth) * 100;
    }

    function pxToVh(px) {
        return (px / window.innerHeight) * 100;
    }

    function vhToPx(vh) {
        return (vh / 100) * window.innerHeight;
    }

    var intervalId;

    document.addEventListener("keydown", (event) => {
        if (event.key === "s") {
            if (!intervalId) {
            createBullets()
            intervalId = setInterval(createBullets, 200)
            }
            if (!animating) {
            shootBullet()
            animating = true
            }
        } 
    })

    document.addEventListener("keyup", (event) => {
        if (event.key === "s") {
            clearInterval(intervalId);
            intervalId = null;
        }
    })

    //if left is below the asteroid, then the bullet needs to be removed when it reaches the asteroid bottom and height

    function createBullets() {
        let shipRect = myShip.getBoundingClientRect();
        let shipLeft = shipRect.left;
        let shipRight = shipRect.right;
        let shipHeight = shipRect.height;
        const bulletStart = shipLeft + shipRect.width/2 - gameLeft - vwToPx(shipBulletWidth)/2;
        const shipBullet = document.createElement("img")
        shipBullet.src = "images/fire.png"
        shipBullet.style.width = "1vw";
        const bottomBullet = 0.5 + pxToVh(shipHeight); 
        shipBullet.style.bottom = bottomBullet + "vh";
        shipBullet.style.position = "absolute";
        shipBullet.style.left = bulletStart + "px";
        shipBullets.push(shipBullet)
        game.appendChild(shipBullet)
    }
    
    function shootBullet() {
       
        for (bullet of shipBullets) {
            let bulletRect = bullet.getBoundingClientRect()
            let bulletHeight = bulletRect.height
            let bulletBottomstr = bullet.style.bottom.slice(0,-2)
            let bulletBottomNum = vhToPx(parseFloat(bulletBottomstr, 10))
            let bulletLeft = bulletRect.left + vwToPx(1)/2 - gameLeft
            if (!(bulletLeft > asteroid1Left && bulletLeft < asteroid1Right) && !(bulletLeft > asteroid2Left && bulletLeft < asteroid2Right) && !(bulletLeft > asteroid3Left && bulletLeft < asteroid3Right) && !(bulletLeft > asteroid4Left && bulletLeft < asteroid4Right)) {
                if (bulletBottomNum + bulletHeight + 5 < gameHeight) {
                    bulletBottomNum += 10;
                    bullet.style.bottom = pxToVh(bulletBottomNum) + "vh";
                } else {
                    shipBullets = shipBullets.filter(b => b !== bullet)
                    bullet.remove()
                }
            } else {
                  if (bulletBottomNum + bulletHeight + 5 < vhToPx(30)) {
                    bulletBottomNum += 10;
                    bullet.style.bottom = pxToVh(bulletBottomNum) + "vh";
                } else {
                    bullet.remove()
                    shipBullets = shipBullets.filter(b => b !== bullet)
                }
            }
        }
        requestAnimationFrame(shootBullet)
    }
    
</script>

</html>